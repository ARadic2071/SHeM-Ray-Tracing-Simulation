function mexCompile(recompile, clear_binaries)
    if nargin < 2
        clear_binaries = false;
    end
    if nargin == 0
        recompile = true;
    end
    
    % Create a directory for the compiled mex binaries
    if ~exist('bin', 'dir')
        mkdir('bin')
    end
    
    if clear_binaries
        delete()
    end
    
    % Compile the main 3D ray tracing library
    if ~exist('atom_ray_tracing_library/atom_ray_tracing3D.o', 'file') || recompile
        mex -c -R2018a CFLAGS='$CFLAGS -Imtwister -Iatom_ray_tracing_library -Wall -pedantic -ffast-math' ...
            -outdir atom_ray_tracing_library ...
            atom_ray_tracing_library/atom_ray_tracing3D.c
    end
    
    % Compile the 2D ray tracing library
    if ~exist('atom_ray_tracing_library/atom_ray_tracing2D.o', 'file') || recompile
        mex -c -R2018a CFLAGS='$CFLAGS -Imtwister -Iatom_ray_tracing_library -Wall -pedantic -ffast-math' ...
            -outdir atom_ray_tracing_library ...
            atom_ray_tracing_library/atom_ray_tracing2D.c
    end
    
    % Compile the mtwister library
    if ~exist('mtwister/mtwister.o', 'file') || recompile
        mex -c -R2018a CFLAGS='$CFLAGS -std=c99 -Imtwister -Iatom_ray_tracing_library -Wall -pedantic -ffast-math' ...
            -outdir mtwister ...
            mtwister/mtwister.c
    end
    
    % For stl pinhole plate and sample
    %mex -R2018a CFLAGS='$CFLAGS -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
    %    mexFiles/tracingMex.c ...
    %    mexFiles/extract_inputs.c ...
    %    atom_ray_tracing_library/atom_ray_tracing3D.o ...
    %    mtwister/mtwister.o
    %mex -R2018a CFLAGS='$CFLAGS -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
    %    mexFiles/tracingGenMex.c ...
    %    mexFiles/extract_inputs.c ...
    %    atom_ray_tracing_library/atom_ray_tracing3D.o ...
    %    mtwister/mtwister.o
    
    if ispc
        % For a simple model of the pinhole plate
        if ~exist('bin/tracingMultiMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/tracingMultiMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.obj ...
                mtwister/mtwister.obj
        end
        if ~exist('bin/tracingMultiGenMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/tracingMultiGenMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.obj ...
                mtwister/mtwister.obj
        end

        % For distribution or trace scattering just off a sample
        if ~exist('bin/distributionCalcMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/distributionCalcMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.obj ...
                mtwister/mtwister.obj
        end

        % For 2D scattering calculations
        if ~exist('bin/scatterRaysMex2D.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/scatterRaysMex2D.c ...
                atom_ray_tracing_library/atom_ray_tracing2D.obj ...
                mtwister/mtwister.obj
        end

        % For testing scattering distributions
        if ~exist('bin/distributionTestMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/distributionTestMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.obj ...
                mtwister/mtwister.obj
        end
    else
        % For a simple model of the pinhole plate
        if ~exist('bin/tracingMultiMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/tracingMultiMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.o ...
                mtwister/mtwister.o
        end
        if ~exist('bin/tracingMultiGenMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/tracingMultiGenMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.o ...
                mtwister/mtwister.o
        end

        % For distribution or trace scattering just off a sample
        if ~exist('bin/distributionCalcMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/distributionCalcMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.o ...
                mtwister/mtwister.o
        end

        % For 2D scattering calculations
        if ~exist('bin/scatterRaysMex2D.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/scatterRaysMex2D.c ...
                atom_ray_tracing_library/atom_ray_tracing2D.o ...
                mtwister/mtwister.o
        end

        % For testing scattering distributions
        if ~exist('bin/distributionTestMex.mexa64', 'file') || recompile
            mex -R2018a CFLAGS='$CFLAGS -std=c99 -I mtwister -I atom_ray_tracing_library -Wall -pedantic -ffast-math' ...
                -outdir bin ...
                mexFiles/distributionTestMex.c ...
                mexFiles/extract_inputs.c ...
                atom_ray_tracing_library/atom_ray_tracing3D.o ...
                mtwister/mtwister.o
        end
    end
    
    % A binning function I wrote.
    if ~exist('bin/binMyWayMex.mexa64') || recompile
        mex -outdir bin mexFiles/binMyWayMex.c CFLAGS='$CFLAGS -std=c99 -Wall -pedantic'
    end
end

